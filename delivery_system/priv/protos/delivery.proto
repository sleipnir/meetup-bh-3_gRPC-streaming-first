syntax = "proto3";

package delivery;

// Serviço de Pedidos
service OrderService {
  // Unary: Cliente faz um pedido
  rpc CreateOrder(OrderRequest) returns (OrderResponse);
  
  // Server Streaming: Cliente acompanha status do pedido em tempo real
  rpc TrackOrder(TrackRequest) returns (stream OrderStatus);
  
  // Client Streaming: Restaurante envia items do pedido um por um
  rpc PrepareOrder(stream OrderItem) returns (PreparationSummary);
  
  // Bidirectional: Chat entre cliente e entregador
  rpc OrderChat(stream ChatMessage) returns (stream ChatMessage);
}

// Serviço de Entregas (para motoristas)
service DeliveryService {
  // Server Streaming: Motorista recebe novos pedidos disponíveis
  rpc StreamAvailableOrders(DriverRequest) returns (stream DeliveryOrder);
  
  // Unary: Motorista aceita um pedido
  rpc AcceptOrder(AcceptRequest) returns (AcceptResponse);
  
  // Client Streaming: Motorista envia atualizações de localização
  rpc UpdateLocation(stream LocationUpdate) returns (LocationSummary);
}

// Mensagens de Pedido
message OrderRequest {
  string customer_id = 1;
  string restaurant_id = 2;
  repeated string items = 3;
  string delivery_address = 4;
}

message OrderResponse {
  string order_id = 1;
  string status = 2;
  double estimated_time = 3;
}

message TrackRequest {
  string order_id = 1;
}

message OrderStatus {
  string order_id = 1;
  string status = 2;  // created, preparing, ready, picked_up, delivered
  string message = 3;
  int64 timestamp = 4;
  optional Location current_location = 5;
}

message OrderItem {
  string order_id = 1;
  string item_name = 2;
  int32 quantity = 3;
  string notes = 4;
}

message PreparationSummary {
  string order_id = 1;
  int32 total_items = 2;
  string status = 3;
}

// Mensagens de Entrega
message DriverRequest {
  string driver_id = 1;
  Location current_location = 2;
}

message DeliveryOrder {
  string order_id = 1;
  string restaurant_name = 2;
  string restaurant_address = 3;
  string delivery_address = 4;
  double distance_km = 5;
  double estimated_payment = 6;
}

message AcceptRequest {
  string driver_id = 1;
  string order_id = 2;
}

message AcceptResponse {
  bool success = 1;
  string message = 2;
  DeliveryOrder order = 3;
}

message LocationUpdate {
  string driver_id = 1;
  string order_id = 2;
  Location location = 3;
  int64 timestamp = 4;
}

message LocationSummary {
  string driver_id = 1;
  int32 updates_received = 2;
  double total_distance_km = 3;
}

// Mensagens de Chat
message ChatMessage {
  string order_id = 1;
  string sender = 2;  // customer ou driver
  string message = 3;
  int64 timestamp = 4;
}

// Tipos comuns
message Location {
  double latitude = 1;
  double longitude = 2;
}
